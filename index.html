<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>The Loop Below</title>
<style>
body { margin:0; overflow:hidden; background:black; }
#overlay {
  position:absolute;
  width:100%;
  height:100%;
  background:black;
  opacity:0;
  pointer-events:none;
  transition:opacity 0.2s;
}
#ui {
  position:absolute;
  top:10px;
  left:10px;
  color:white;
  font-family:Arial;
  z-index:10;
}
button {
  padding:12px;
  font-size:18px;
}
</style>
</head>
<body>

<div id="ui">
<button onclick="startGame()">ENTER</button>
<div id="info"></div>
</div>

<div id="overlay"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>

<script>
let scene, camera, renderer;
let monster;
let moving=false;
let stamina=100;
let blinkCooldown=false;
let chasing=false;
let loopCount=0;
let hallwayLength=200;
let overlay=document.getElementById("overlay");

function startGame(){
  document.getElementById("ui").style.display="none";
  init();
  animate();
}

function init(){
  scene=new THREE.Scene();
  scene.fog=new THREE.Fog(0x000000,5,40);

  camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);
  camera.position.set(0,1.6,5);

  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth,window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio);
  document.body.appendChild(renderer.domElement);

  let light=new THREE.PointLight(0xffffff,1,15);
  light.position.set(0,3,5);
  scene.add(light);

  let floor=new THREE.Mesh(
    new THREE.PlaneGeometry(10,hallwayLength),
    new THREE.MeshStandardMaterial({color:0x111111})
  );
  floor.rotation.x=-Math.PI/2;
  floor.position.z=-hallwayLength/2;
  scene.add(floor);

  let wallMat=new THREE.MeshStandardMaterial({color:0x222222});
  for(let i=0;i<50;i++){
    let z=-i*4;
    let wallL=new THREE.Mesh(new THREE.BoxGeometry(1,4,2),wallMat);
    wallL.position.set(-3,2,z);
    scene.add(wallL);

    let wallR=wallL.clone();
    wallR.position.set(3,2,z);
    scene.add(wallR);
  }

  monster=new THREE.Mesh(
    new THREE.BoxGeometry(1.5,2,1),
    new THREE.MeshStandardMaterial({color:0xaa0000})
  );
  monster.position.set(0,1,-30);
  scene.add(monster);

  window.addEventListener("touchstart",()=>moving=true);
  window.addEventListener("touchend",()=>moving=false);

  window.addEventListener("dblclick",blink);

  window.addEventListener("resize",()=>{
    camera.aspect=window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth,window.innerHeight);
  });
}

function blink(){
  if(blinkCooldown) return;
  blinkCooldown=true;
  overlay.style.opacity=1;
  setTimeout(()=>{
    overlay.style.opacity=0;
  },200);

  if(Math.random()<0.4){
    monster.position.z=camera.position.z-5;
  }

  setTimeout(()=>blinkCooldown=false,1000);
}

function animate(){
  requestAnimationFrame(animate);

  if(moving && stamina>0){
    camera.position.z-=0.08;
    stamina-=0.1;
  } else {
    stamina+=0.05;
    if(stamina>100) stamina=100;
  }

  if(Math.random()<0.005){
    scene.background=new THREE.Color(0x111111);
  } else {
    scene.background=new THREE.Color(0x000000);
  }

  if(camera.position.z<-hallwayLength+10){
    camera.position.z=5;
    loopCount++;
    if(loopCount>2){
      chasing=true;
    }
  }

  if(chasing){
    monster.position.z+=0.15;
  } else {
    if(camera.position.z<monster.position.z+12){
      monster.position.z+=0.05;
    }
  }

  if(Math.abs(camera.position.z-monster.position.z)<1){
    alert("It found you.");
    location.reload();
  }

  renderer.render(scene,camera);
}
</script>
</body>
</html>
